--Quotation
selectdistinctru.nameasSalesperson
,so.date_order
,so.nameasQuote_No
,cust.commercial_company_nameasCustomer_Name
,order_desc.Description
,so.amount_totalasSales_Amount_HKD
,casewhenso.state='draft'then'Outstading'whenso.state='sale'then'Completed'elseso.stateendasState
,''asRemark
fromsale_orderso
leftjoin(selectru.id,rp.display_nameasnamefromres_usersru
joinres_partnerrponru.partner_id=rp.id)ruonso.user_id=ru.id
leftjoinres_partnercustonso.partner_id=cust.id
leftjoin(selectsol.order_id,string_agg(pt.name,'/')asDescription
fromsale_order_linesol
joinproduct_productpponsol.product_id=pp.id
joinproduct_templateptonpp.product_tmpl_id=pt.id
groupbysol.order_id)order_desconorder_id=so.id
where(so.create_date>'2020-01-01')
--andso.name='ATC200828-011'
orderbyso.name
;
--DeliveryNote
selectdistinctsp.scheduled_dateasDN_Date
,sp.nameasDN_No
,cust.commercial_company_nameasCustomer_Name
,sp.originasSale_Order
,casewhensp.state='assigned'then'outstanding'
whensp.state='done'then'completed'
elsesp.state
endasstate
,''asRemark
fromstock_pickingsp
leftjoinres_partnercustonsp.partner_id=cust.id
where(sp.create_date>'2020-01-01')
--andso.name='ATC200828-011'
orderbysp.name
;

--Invoice
selectdistinctru.nameasSalesperson,so.nameasRef_Quote_No,''asDN_No,ai.date_invoiceasInv_Date
,ai.numberasInv_No,cust.commercial_company_nameasCustomer_Name
,order_desc.Description,''asSalesman,''asPayment_Terms
,0asSales_Amount_RMB
,0asSales_Amount_HKD
,0asCost,0asGross_Profit
,casewhenai.state='paid'thenai.amount_totalelse0endasDeposit
,casewhenai.state='open'thenai.amount_totalelse0endasBalance
,ap.payment_dateasPay_Date
,casewhenai.state='open'then'outstanding'whenai.state='paid'then'completed'endasState
,ap.communicationasCHQ,''asRemark,so.*
fromsale_orderso
leftjoin(selectru.id,rp.display_nameasnamefromres_usersru
joinres_partnerrponru.partner_id=rp.id)ruonso.user_id=ru.id
join(selectai.*
fromaccount_invoiceai
wherenotexists(select1fromaccount_invoiceai1whereai.number=ai1.origin)
andnotexists(select1fromaccount_invoiceai1whereai.origin=ai1.number))aionai.origin=so.name
leftjoinres_partnercustonso.partner_id=cust.id
leftjoin(selectsol.order_id,string_agg(pt.name,'/')asDescription
fromsale_order_linesol
joinproduct_productpponsol.product_id=pp.id
joinproduct_templateptonpp.product_tmpl_id=pt.id
groupbysol.order_id)order_desconorder_id=so.id
leftjoin(selectinvoice_id,payment_date,ap.communication
fromaccount_invoice_payment_relaipr
joinaccount_paymentaponaipr.payment_id=ap.id
)aponai.id=ap.invoice_id
where(so.create_date>'2020-01-01'ordate_invoice>'2020-01-01')
--andso.name='ATC200828-011'
orderbyso.name
;

